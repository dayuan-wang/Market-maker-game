<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Market Maker Challenge</title>
    <!-- 1. Load Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Simple transition for all elements */
        * { transition: all 0.2s ease-in-out; }
        /* Style for the log messages */
        .log-entry {
            border-left-width: 4px;
            padding-left: 8px;
            margin-bottom: 4px;
        }
        .log-buy { border-color: #22c55e; } /* Green for Buy */
        .log-sell { border-color: #ef4444; } /* Red for Sell */
        .log-system { border-color: #f97316; } /* Orange for System */
    </style>
</head>
<body class="bg-gray-900 text-gray-100 flex items-center justify-center min-h-screen font-sans">

    <div class="w-full max-w-md bg-gray-800 rounded-lg shadow-xl p-6">
        
        <h1 class="text-2xl font-bold text-center text-blue-400 mb-4">Market Maker Challenge</h1>
        <p class="text-sm text-gray-400 mb-1">
            - The Setup: The hidden 'True Value' (X) of an asset is an integer between 5 and 95. You do not know this value.
        </p>
        <p class="text-sm text-gray-400 mb-1">
            - The market is composed of 2 types of traders, both types believe that they know the true value of the stock. 50% Bulls believe X+5 is the True Value and 50% Bears believe X-5 is the True Value.
        </p>
        <p class="text-sm text-gray-400 mb-4">
            - How to Play:
            1. You are the Market Maker. In each round, you submit a Bid price.
            2. Your Ask price is automatically set to Bid + 10.
            3.A single trader (a Bull or a Bear, 50/50 chance) will appear.
            4. Each trader (either a Bear or a Bull) will check your market and decide to BUY, SELL, or NOT TRADE. They will not trade if they dont think the market is profitable. 
            5. The game ends after 10 rounds.
        </p>
        <!-- Scoreboard -->
        <div class="grid grid-cols-3 gap-4 text-center mb-6 bg-gray-900 p-4 rounded-lg">
            <div>
                <!-- UPDATED: "TRADES" to "ROUNDS" -->
                <span class="block text-xs text-gray-400">ROUNDS</span>
                <span id="round-count" class="text-2xl font-bold">0</span> / 10
            </div>
            <div>
                <span class="block text-xs text-gray-400">INVENTORY</span>
                <span id="inventory" class="text-2xl font-bold">0</span>
            </div>
            <div>
                <span class="block text-xs text-gray-400">CASH PNL</span>
                <span id="pnl" class="text-lg font-bold">$0.00</span>
            </div>
        </div>

        <!-- Game Controls -->
        <div id="game-controls">
            <div class="flex items-center space-x-4 mb-4">
                <div class="flex-1">
                    <label for="bid-input" class="block text-sm font-medium text-gray-400">Your Bid</label>
                    <input type="number" id="bid-input" class="mt-1 block w-full bg-gray-700 border-gray-600 rounded-md shadow-sm p-2 text-white text-lg font-bold" placeholder="e.g. 30">
                </div>
                <div class="flex-1 text-center">
                    <span class="block text-sm font-medium text-gray-400">Your Ask</span>
                    <span id="ask-display" class="mt-1 block w-full bg-gray-700 rounded-md p-2 text-white text-lg font-bold">--</span>
                </div>
            </div>
            <button id="submit-button" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg text-lg">
                Submit Market
            </button>
        </div>

        <!-- Game Log -->
        <div class="mt-4">
            <h3 class="text-sm font-semibold text-gray-400 mb-2">Trade Log</h3>
            <div id="log-box" class="h-40 bg-gray-900 rounded-lg p-3 overflow-y-auto text-sm">
                <!-- Log messages will be added here -->
            </div>
        </div>

        <!-- Game Over Screen (Hidden by default) -->
        <div id="game-over" class="hidden text-center p-6 bg-gray-700 rounded-lg mt-4">
            <h2 class="text-2xl font-bold text-orange-400 mb-4">Game Over!</h2>
            <p class="text-lg">The secret 'True Value' (X) was: <span id="true-value" class="font-bold text-white">--</span></p>
            <p class="text-lg">Your Cash PnL: <span id="final-cash" class="font-bold text-white">--</span></p>
            <p class="text-lg">Inventory Value: <span id="final-inventory-value" class="font-bold text-white">--</span></p>
            <hr class="border-gray-500 my-4">
            <p class="text-2xl">Final PnL: <span id="final-pnl" class="font-bold text-green-400">--</span></p>
            <button id="reset-button" class="mt-6 bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">
                Play Again
            </button>
        </div>

    </div>

    <!-- 2. Game Logic -->
    <script>
        // --- Global Variables ---
        let true_value_X;
        let bull_belief;
        let bear_belief;
        let inventory = 0;
        let pnl = 0.0;
        // UPDATED: "trade_count" to "round_count"
        let round_count = 0;
        const SPREAD = 10;
        const MAX_ROUNDS = 10; // Renamed from MAX_TRADES

        // --- DOM Element References ---
        // UPDATED: "tradeCountSpan" to "roundCountSpan"
        const roundCountSpan = document.getElementById('round-count');
        const inventorySpan = document.getElementById('inventory');
        const pnlSpan = document.getElementById('pnl');
        const bidInput = document.getElementById('bid-input');
        const askDisplaySpan = document.getElementById('ask-display');
        const submitButton = document.getElementById('submit-button');
        const logBox = document.getElementById('log-box');
        
        const gameOverDiv = document.getElementById('game-over');
        const gameControlsDiv = document.getElementById('game-controls');
        
        const trueValueSpan = document.getElementById('true-value');
        const finalCashSpan = document.getElementById('final-cash');
        const finalInventoryValueSpan = document.getElementById('final-inventory-value');
        const finalPnlSpan = document.getElementById('final-pnl');
        const resetButton = document.getElementById('reset-button');

        // --- Core Functions ---

        /**
         * Resets the game to its initial state
         */
        function startGame() {
            true_value_X = Math.floor(Math.random() * 91) + 5;
            bull_belief = true_value_X + 5;
            bear_belief = true_value_X - 5;
            
            inventory = 0;
            pnl = 0.0;
            round_count = 0; // Renamed

            // Reset UI
            roundCountSpan.textContent = "0"; // Renamed
            inventorySpan.textContent = "0";
            pnlSpan.textContent = "$0.00";
            bidInput.value = "";
            askDisplaySpan.textContent = "--";
            logBox.innerHTML = "";
            
            gameOverDiv.classList.add('hidden');
            gameControlsDiv.classList.remove('hidden');
            bidInput.disabled = false; // Ensure input is enabled
            submitButton.disabled = false;

            addLogMessage("New game started. Maximize your PnL!", "system");
        }

        /**
         * Updates the Ask display as the user types a Bid
         */
        function updateAskDisplay() {
            const bid = parseInt(bidInput.value);
            if (isNaN(bid)) {
                askDisplaySpan.textContent = "--";
            } else {
                askDisplaySpan.textContent = bid + SPREAD;
            }
        }

        /**
         * Adds a message to the game log
         * UPDATED: Now takes bid and ask to record the market
         */
        function addLogMessage(message, logType, bid, ask) {
            let entry = document.createElement('div');
            
            // Format the message
            let fullMessage = message;
            if (bid !== undefined && ask !== undefined) {
                // Prepend the market info
                fullMessage = `[Mkt: ${bid}@${ask}] ${message}`;
            }
            entry.textContent = fullMessage;
            
            // Set color class based on logType
            if (logType === 'buy') {
                entry.className = 'log-entry log-buy';
            } else if (logType === 'sell') {
                entry.className = 'log-entry log-sell';
            } else { // 'system' or 'no_trade'
                entry.className = 'log-entry log-system';
            }
            
            logBox.prepend(entry); // Add to the top
        }

        /**
         * Ends the game and shows the final score
         */
        function endGame() {
            bidInput.disabled = true;
            submitButton.disabled = true;
            gameControlsDiv.classList.add('hidden');
            gameOverDiv.classList.remove('hidden');

            const inventoryValue = inventory * true_value_X;
            const finalPnl = pnl + inventoryValue;

            trueValueSpan.textContent = true_value_X;
            finalCashSpan.textContent = `$${pnl.toFixed(2)}`;
            finalInventoryValueSpan.textContent = `$${inventoryValue.toFixed(2)} (${inventory} @ $${true_value_X})`;
            finalPnlSpan.textContent = `$${finalPnl.toFixed(2)}`;

            if (finalPnl > 0) {
                finalPnlSpan.classList.add('text-green-400');
                finalPnlSpan.classList.remove('text-red-400');
            } else if (finalPnl < 0) {
                finalPnlSpan.classList.add('text-red-400');
                finalPnlSpan.classList.remove('text-green-400');
            }
        }

        /**
         * Main game loop, called on button click
         */
        function playRound() {
            const bid_price = parseInt(bidInput.value);
            if (isNaN(bid_price)) {
                addLogMessage("Please enter a valid Bid price.", "system");
                return;
            }
            
            const ask_price = bid_price + SPREAD;
            
            // UPDATED: Increment round count every valid click
            round_count++;

            // 1. A random trader appears
            const trader_type = Math.random() < 0.5 ? 'bull' : 'bear';
            
            if (trader_type === 'bull') {
                // --- Bull Logic (believes X+5) ---
                if (ask_price < bull_belief) {
                    addLogMessage(`A trader BOUGHT 1 share @ $${ask_price.toFixed(2)}`, "buy", bid_price, ask_price);
                    inventory--;
                    pnl += ask_price;
                } else if (bid_price > bull_belief) {
                    addLogMessage(`A trader SOLD 1 share @ $${bid_price.toFixed(2)}`, "sell", bid_price, ask_price);
                    inventory++;
                    pnl -= bid_price;
                } else {
                    addLogMessage("A trader appeared. NO TRADE.", "system", bid_price, ask_price);
                }
                
            } else {
                // --- Bear Logic (believes X-5) ---
                if (bid_price > bear_belief) {
                    addLogMessage(`A trader SOLD 1 share @ $${bid_price.toFixed(2)}`, "sell", bid_price, ask_price);
                    inventory++;
                    pnl -= bid_price;
                } else if (ask_price < bear_belief) {
                    addLogMessage(`A trader BOUGHT 1 share @ $${ask_price.toFixed(2)}`, "buy", bid_price, ask_price);
                    inventory--;
                    pnl += ask_price;
                } else {
                    addLogMessage("A trader appeared. NO TRADE.", "system", bid_price, ask_price);
                }
            }

            // 3. Update scores
            roundCountSpan.textContent = round_count;
            inventorySpan.textContent = inventory;
            pnlSpan.textContent = `$${pnl.toFixed(2)}`;

            // 4. Check for game over
            // UPDATED: Check round_count and MAX_ROUNDS
            if (round_count >= MAX_ROUNDS) {
                endGame();
            }
        }

        // --- 3. Event Listeners ---
        
        document.addEventListener('DOMContentLoaded', startGame);
        submitButton.addEventListener('click', playRound);
        resetButton.addEventListener('click', startGame);
        bidInput.addEventListener('input', updateAskDisplay);
        
        bidInput.addEventListener('keyup', function(event) {
            if (event.key === "Enter") {
                submitButton.click();
            }
        });

    </script>
</body>
</html>

